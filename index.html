<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>唱片播放器交互</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #f0f0f0;
            overflow: hidden;
        }

        #svg-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        svg {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
        }
    </style>
</head>
<body>
    <div id="svg-container"></div>

    <!-- 音频元素 -->
    <audio id="weeknd-audio" src="After_Hours.mp3" loop></audio>
    <audio id="beatles-audio" src="Oh_Darling.mp3" loop></audio>
    <audio id="charlie-audio" src="We_Don't_Talk_Anymore.mp3" loop></audio>

    <script>
        // 加载 SVG 文件
        fetch('Recordplayer.svg')
            .then(response => response.text())
            .then(svgContent => {
                document.getElementById('svg-container').innerHTML = svgContent;
                initInteraction();
            })
            .catch(error => {
                console.error('加载 SVG 失败:', error);
            });

        function initInteraction() {
            // 获取元素
            const weekndCover = document.getElementById('Weeknd');
            const beatlesCover = document.getElementById('Beatles');
            const charlieCover = document.getElementById('Charlie');

            const weekndRecord = document.getElementById('WeekndRecord');
            const beatlesRecord = document.getElementById('BeatlesRecord');
            const charlieRecord = document.getElementById('CharlieRecord');

            const recordCenter = document.getElementById('RecordCenter');

            // 获取音频元素
            const weekndAudio = document.getElementById('weeknd-audio');
            const beatlesAudio = document.getElementById('beatles-audio');
            const charlieAudio = document.getElementById('charlie-audio');

            // 获取唱臂元素
            const playerArm1 = document.getElementById('Playerarm');
            const playerArm2 = document.getElementById('Playerarm2');

            // 获取播放按钮
            const playButton = document.getElementById('Startpoint');

            // 获取 RecordCenter 的位置
            const centerX = 1483;
            const centerY = 527;

            // 唱片的原始位置
            const recordPositions = {
                weeknd: { x: 872, y: 175 },
                beatles: { x: 871, y: 533 },
                charlie: { x: 870, y: 891 }
            };

            // 当前显示的唱片和音频
            let currentRecord = null;
            let currentAudio = null;
            let isArmTilted = false; // 唱臂是否倾斜
            let isPlaying = false; // 是否正在播放

            // 移动唱片到中心并播放音乐的函数
            function moveRecordToCenter(record, recordName, audio) {
                if (!record) return;

                // 如果点击的是当前正在显示的唱片，则不做任何操作
                if (currentRecord === record) {
                    return;
                }

                // 停止之前的音乐并重置播放状态
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                }
                isPlaying = false;

                // 隐藏之前的唱片
                if (currentRecord) {
                    currentRecord.classList.remove('show');
                    currentRecord.style.transform = '';

                    // 等待动画完成后重置
                    setTimeout(() => {
                        if (currentRecord !== record) {
                            currentRecord.classList.remove('show');
                        }
                    }, 300);
                }

                // 切换唱片时，重置唱臂到竖直状态
                if (isArmTilted) {
                    isArmTilted = false;
                    // 确保过渡效果生效
                    playerArm1.style.transition = 'opacity 0.5s ease-in-out';
                    playerArm2.style.transition = 'opacity 0.5s ease-in-out';
                    playerArm1.style.opacity = '1';
                    playerArm1.style.pointerEvents = 'auto';
                    playerArm2.style.opacity = '0';
                    playerArm2.style.pointerEvents = 'none';
                }

                // 计算移动距离
                const originalPos = recordPositions[recordName];
                const translateX = centerX - originalPos.x;
                const translateY = centerY - originalPos.y;

                // 显示并移动新唱片
                record.classList.add('show');

                // 使用 requestAnimationFrame 确保 transition 生效
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        record.style.transform = `translate(${translateX}px, ${translateY}px)`;
                    });
                });

                // 设置当前音频（不自动播放）
                currentAudio = audio;
                currentRecord = record;
            }

            // 拖拽专辑封面功能
            let isDraggingCover = false;
            let draggedCover = null;
            let draggedRecord = null;
            let draggedAudio = null;
            let draggedRecordName = null;

            // 获取 SVG 元素用于坐标转换
            function getSVGPoint(clientX, clientY) {
                const svg = document.querySelector('svg');
                if (!svg) return { x: clientX, y: clientY };

                const pt = svg.createSVGPoint();
                pt.x = clientX;
                pt.y = clientY;
                const svgP = pt.matrixTransform(svg.getScreenCTM().inverse());
                return { x: svgP.x, y: svgP.y };
            }

            function startCoverDrag(e, cover, record, audio, recordName) {
                isDraggingCover = true;
                draggedCover = cover;
                draggedRecord = record;
                draggedAudio = audio;
                draggedRecordName = recordName;

                // 添加视觉反馈
                cover.style.opacity = '0.7';
                e.preventDefault();
            }

            function onCoverDrag(e) {
                if (!isDraggingCover) return;

                const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                const clientY = e.clientY || (e.touches && e.touches[0].clientY);

                // 转换为 SVG 坐标
                const svgPoint = getSVGPoint(clientX, clientY);

                // 检查是否拖拽到播放器区域（播放器中心附近）
                const distanceToCenter = Math.sqrt(
                    Math.pow(svgPoint.x - centerX, 2) + Math.pow(svgPoint.y - centerY, 2)
                );

                // 视觉反馈：靠近播放器时改变透明度
                if (distanceToCenter < 300) {
                    draggedCover.style.opacity = '0.5';
                } else {
                    draggedCover.style.opacity = '0.7';
                }
            }

            function endCoverDrag(e) {
                if (!isDraggingCover) return;

                const clientX = e.clientX || (e.changedTouches && e.changedTouches[0].clientX);
                const clientY = e.clientY || (e.changedTouches && e.changedTouches[0].clientY);

                // 恢复透明度
                draggedCover.style.opacity = '1';

                // 转换为 SVG 坐标
                const svgPoint = getSVGPoint(clientX, clientY);

                // 检查是否拖拽到播放器区域
                const distanceToCenter = Math.sqrt(
                    Math.pow(svgPoint.x - centerX, 2) + Math.pow(svgPoint.y - centerY, 2)
                );

                console.log('Drop position:', svgPoint, 'Distance to center:', distanceToCenter);

                // 如果拖拽到播放器附近（半径 300px），则放置唱片
                if (distanceToCenter < 300) {
                    moveRecordToCenter(draggedRecord, draggedRecordName, draggedAudio);
                    console.log('唱片已放置');
                } else {
                    console.log('拖拽位置太远，未放置唱片');
                }

                isDraggingCover = false;
                draggedCover = null;
                draggedRecord = null;
                draggedAudio = null;
                draggedRecordName = null;
            }

            // 为专辑封面添加拖拽事件
            if (weekndCover) {
                weekndCover.addEventListener('mousedown', (e) => {
                    startCoverDrag(e, weekndCover, weekndRecord, weekndAudio, 'weeknd');
                });
                weekndCover.addEventListener('touchstart', (e) => {
                    startCoverDrag(e, weekndCover, weekndRecord, weekndAudio, 'weeknd');
                });
            }

            if (beatlesCover) {
                beatlesCover.addEventListener('mousedown', (e) => {
                    startCoverDrag(e, beatlesCover, beatlesRecord, beatlesAudio, 'beatles');
                });
                beatlesCover.addEventListener('touchstart', (e) => {
                    startCoverDrag(e, beatlesCover, beatlesRecord, beatlesAudio, 'beatles');
                });
            }

            if (charlieCover) {
                charlieCover.addEventListener('mousedown', (e) => {
                    startCoverDrag(e, charlieCover, charlieRecord, charlieAudio, 'charlie');
                });
                charlieCover.addEventListener('touchstart', (e) => {
                    startCoverDrag(e, charlieCover, charlieRecord, charlieAudio, 'charlie');
                });
            }

            // 全局拖拽事件（专辑封面）
            document.addEventListener('mousemove', onCoverDrag);
            document.addEventListener('touchmove', onCoverDrag);
            document.addEventListener('mouseup', endCoverDrag);
            document.addEventListener('touchend', endCoverDrag);

            // 切换唱臂状态的函数（拖拽版本）
            let isDragging = false;
            let dragStartX = 0;
            let dragStartY = 0;
            let dragProgress = 0; // 0 = 竖直, 1 = 倾斜

            function startDrag(e) {
                // 只有当有唱片在播放器上时才能拖拽唱臂
                if (!currentRecord) {
                    console.log('请先选择一张专辑');
                    return;
                }

                isDragging = true;
                const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                const clientY = e.clientY || (e.touches && e.touches[0].clientY);
                dragStartX = clientX;
                dragStartY = clientY;

                // 禁用过渡效果，使拖拽更流畅
                playerArm1.style.transition = 'none';
                playerArm2.style.transition = 'none';

                e.preventDefault();
            }

            function onDrag(e) {
                if (!isDragging) return;

                const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                const clientY = e.clientY || (e.touches && e.touches[0].clientY);

                // 计算拖拽距离（主要是水平方向）
                const deltaX = clientX - dragStartX;
                const deltaY = clientY - dragStartY;

                // 使用向左拖拽来触发倾斜（向左拖拽时 deltaX 为负）
                // 或者使用向下拖拽
                const dragDistance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                const dragThreshold = 100; // 拖拽阈值（像素）

                // 计算拖拽进度 (0-1)
                dragProgress = Math.max(0, Math.min(1, dragDistance / dragThreshold));

                // 如果向右或向上拖拽，则反向（恢复竖直）
                if (deltaX > 0 || deltaY < -10) {
                    dragProgress = Math.max(0, 1 - dragDistance / dragThreshold);
                }

                // 更新两个唱臂的透明度
                updateArmOpacity(dragProgress);

                e.preventDefault();
            }

            function endDrag(e) {
                if (!isDragging) return;

                isDragging = false;

                // 恢复过渡效果
                playerArm1.style.transition = 'opacity 0.5s ease-in-out';
                playerArm2.style.transition = 'opacity 0.5s ease-in-out';

                // 根据拖拽进度决定最终状态
                if (dragProgress > 0.5) {
                    // 完全切换到倾斜状态
                    isArmTilted = true;
                    updateArmOpacity(1);
                    // 倾斜时播放音乐
                    if (currentAudio && isPlaying) {
                        currentAudio.play().catch(error => {
                            console.log('音频播放错误:', error);
                        });
                    }
                    console.log('唱臂切换到倾斜状态');
                } else {
                    // 恢复到竖直状态
                    isArmTilted = false;
                    updateArmOpacity(0);
                    // 竖直时暂停音乐
                    if (currentAudio && isPlaying) {
                        currentAudio.pause();
                    }
                    console.log('唱臂恢复到竖直状态');
                }

                e.preventDefault();
            }

            function updateArmOpacity(progress) {
                // progress: 0 = 竖直, 1 = 倾斜
                const arm1Opacity = 1 - progress;
                const arm2Opacity = progress;

                playerArm1.style.opacity = arm1Opacity;
                playerArm2.style.opacity = arm2Opacity;

                // 更新 pointer-events
                if (arm1Opacity > 0.5) {
                    playerArm1.style.pointerEvents = 'auto';
                    playerArm2.style.pointerEvents = 'none';
                } else {
                    playerArm1.style.pointerEvents = 'none';
                    playerArm2.style.pointerEvents = 'auto';
                }
            }

            // 为唱臂添加拖拽事件
            if (playerArm1) {
                playerArm1.addEventListener('mousedown', startDrag);
                playerArm1.addEventListener('touchstart', startDrag);
            }

            if (playerArm2) {
                playerArm2.addEventListener('mousedown', startDrag);
                playerArm2.addEventListener('touchstart', startDrag);
            }

            // 全局 move 和 up 事件
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('touchmove', onDrag, { passive: false });
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);

            // 播放按钮点击事件
            if (playButton) {
                playButton.addEventListener('click', () => {
                    if (!currentRecord || !currentAudio) {
                        console.log('请先选择一张专辑');
                        return;
                    }

                    if (!isPlaying) {
                        // 开始播放
                        isPlaying = true;
                        if (isArmTilted) {
                            currentAudio.play().catch(error => {
                                console.log('音频播放错误:', error);
                            });
                        }
                        console.log('播放已启动');
                    } else {
                        // 停止播放
                        isPlaying = false;
                        currentAudio.pause();
                        console.log('播放已停止');
                    }
                });
            }

            // 弹出唱片的函数
            function ejectRecord() {
                if (!currentRecord) {
                    return;
                }

                // 停止音乐
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                }
                isPlaying = false;

                // 重置唱臂到竖直状态
                if (isArmTilted) {
                    isArmTilted = false;
                    playerArm1.style.transition = 'opacity 0.5s ease-in-out';
                    playerArm2.style.transition = 'opacity 0.5s ease-in-out';
                    playerArm1.style.opacity = '1';
                    playerArm1.style.pointerEvents = 'auto';
                    playerArm2.style.opacity = '0';
                    playerArm2.style.pointerEvents = 'none';
                }

                // 隐藏唱片
                currentRecord.classList.remove('show');
                currentRecord.style.transform = '';

                setTimeout(() => {
                    currentRecord = null;
                    currentAudio = null;
                }, 300);

                console.log('唱片已弹出');
            }

            // ESC 键事件
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' || e.key === 'Esc') {
                    ejectRecord();
                }
            });

            console.log('交互功能已初始化');
            console.log('拖拽左侧的专辑封面到播放器中心选择唱片');
            console.log('点击播放按钮开始/停止播放');
            console.log('拖拽唱臂：倾斜播放，竖直暂停');
            console.log('按 ESC 键弹出唱片');
        }
    </script>
</body>
</html>
